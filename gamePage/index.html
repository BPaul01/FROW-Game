<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="GamePageEasy.css" />
    <title>GamePageEasy</title>
</head>

<body>
<header class="header">
    <div class="titleGame">
        <span class="red-text">F</span>
        <span class="green-text">R</span>
        <span class="orange-text">O</span>
        <span class="yellow-text">W</span>
        <sub class="orange-text">game</sub>
    </div>

    <div class="score">
        <p>Scorul tau: </p>
        <p id="currentScore" class=""></p>
    </div>



    <button class="button buttonHeader" onclick="goBackMyProfile(event)">Ieşi din joc</button>
</header>

<main>
    <div class="main1">
        <div class="containerRectangle">
            <p class="intrebare">Întrebarea:</p>
            <p class="numar" id="numar"></p>
        </div>

        <div class="containterImage">
            <h2>Alege răspunsul corect</h2>
            <img
                    src="/assets/images/loader.gif"
                    id="question_image"
                    alt="fruct/leguma"
            />
        </div>

        <div class="containerRectangle">
            <p class="dificultate">Dificultate:</p>
            <p class="nivel" id="difficulty"></p>
        </div>
    </div>

    <input type="hidden" id="questId" value="0" />
    <div class="main2" id="main2">
    </div>
</main>
</body>

<script>
    const token = localStorage.getItem("token");

    function searchForTrue(text) {
        const regex = /\btrue\b/gi;
        const matches = text.match(regex);

        if (matches && matches.length > 0) {
            return true;
        } else {
            return false;
        }
    }

    function validateAnswer(event,button) {
        event.preventDefault();
        //get the content of the button
        if(document.getElementById(button).type == "text") {
            answer = document.getElementById(button).value;
        } else {
            answer = document.getElementById(button).textContent;
        }
        //get the id of the question
        questId = document.getElementById("questId").value;

        fetch(`/answers?questionId=${questId}&receivedAnswer=${answer}`, {
            method: "GET",
            headers: new Headers({ Authentication: `Bearer ${token}` }),
        })
            .then(response => response.text())
            .then(data => {

                //update score if answer is correct
                if(searchForTrue(data)){

                    let score = localStorage.getItem("score");
                    score = parseInt(score) + 1;
                    localStorage.setItem("score", score);
                }
                location.reload();
            });

    }

    function fetchQuestion(difficulty) {
        fetch("/questions?difficulty=" + difficulty, {
            method: "GET",
            headers: new Headers({ Authentication: `Bearer ${token}` }),
        })
            .then((response) => response.json())
            .then((data) => {
                document.getElementById("questId").value = data.id;

                if(difficulty == 'hard'){

                    let inputResponse = "";

                    inputResponse += `<form method = "post" class="form" onsubmit="validateAnswer(event,'buttonRaspuns')">
                <input class="buttonRaspunsHard" id = "buttonRaspuns" type="text" placeholder="Scrie răspunsul">`;
                    inputResponse +=`<button type="submit" class="button buttonSubmit">Trimite răspunsul</button>
            </form>`;

                    document.getElementById("main2").innerHTML = inputResponse;
                }
                else {

                    let buttons = "";
                    buttons += `<button
                    class="button buttonRaspuns"
                    id="button1"
                    onClick="validateAnswer(event,'button1')"
            >${data.answers[0]}</button>`;
                    buttons += `<button
                    class="button buttonRaspuns"
                    id="button2"
                    onClick="validateAnswer(event,'button2')"
            >${data.answers[1]}</button>`;
                    buttons += `<button
                    class="button buttonRaspuns"
                    id="button3"
                    onClick="validateAnswer(event,'button3')"
            >${data.answers[2]}</button>`;

                    document.getElementById("main2").innerHTML = buttons;
                }

                document.getElementById(
                    "question_image"
                ).src = `/assets/images/questions/${data.id}/${data.photo}`;
            });

    }

    function updateIndex() {
        let questionIndex = localStorage.getItem("questionIndex");
        questionIndex = parseInt(questionIndex) + 1;
        localStorage.setItem("questionIndex", questionIndex);

        document.getElementById("numar").innerHTML =
            localStorage.getItem("questionIndex");
    }

    function getDifficultyFromRequest() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("difficulty");
    }

    function goBackMyProfile(event){
        event.preventDefault();

        location.assign("/myProfile/index.html")
    }

    window.onload = function () {
        let difficulty = getDifficultyFromRequest();

        document.getElementById("difficulty").innerHTML = difficulty;
        document.getElementById("currentScore").innerHTML = localStorage.getItem("score");

        fetchQuestion(difficulty);
        updateIndex();
    };



</script>
</html>
